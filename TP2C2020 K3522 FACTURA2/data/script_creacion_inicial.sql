

--Borrar todo si existe, para volver a crearlo.

IF EXISTS (SELECT SCHEMA_ID FROM sys.schemas WHERE [name] = 'GDD2020')
BEGIN
	PRINT('ESQUEMA EXISTENTE, eliminando...');

	PRINT('ELIMINANDO CONSTRAINTS');

	-- 28 CONSTRAINTS
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_COMPRA_NRO_ITEM')  )
	ALTER TABLE [GDD2020].ITEM_COMPRA DROP CONSTRAINT FK_COMPRA_NRO_ITEM
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_CLIENTE_CODIGO_ITEM_FACTURA')  )
	ALTER TABLE [GDD2020].ITEM_FACTURA DROP CONSTRAINT FK_CLIENTE_CODIGO_ITEM_FACTURA
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FACTURA_NRO_ITEM')  )
	ALTER TABLE [GDD2020].ITEM_FACTURA DROP CONSTRAINT FK_FACTURA_NRO_ITEM
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_SUCURSAL_CODIGO_COMPRA')  )
	ALTER TABLE [GDD2020].COMPRA DROP CONSTRAINT FK_SUCURSAL_CODIGO_COMPRA
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_CLIENTE_CODIGO_COMPRA')  )
	ALTER TABLE [GDD2020].COMPRA DROP CONSTRAINT FK_CLIENTE_CODIGO_COMPRA
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_SUCURSAL_CODIGO_FACTURACION')  )
	ALTER TABLE [GDD2020].FACTURACION DROP CONSTRAINT FK_SUCURSAL_CODIGO_FACTURACION
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_MODELO_CODIGO_COMPRA_AUTOPARTE')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOPARTE DROP CONSTRAINT FK_MODELO_CODIGO_COMPRA_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FABRICANTE_CODIGO_COMPRA_AUTOPARTE')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOPARTE DROP CONSTRAINT FK_FABRICANTE_CODIGO_COMPRA_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_SUCURSAL_CODIGO_COMPRA_AUTOPARTE')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOPARTE DROP CONSTRAINT FK_SUCURSAL_CODIGO_COMPRA_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_COMPRA_NRO_COMRPA_AUTOPARTE')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOPARTE DROP CONSTRAINT FK_COMPRA_NRO_COMRPA_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_SUCURSAL_CODIGO_FAC_AUTOPARTE')  )
	ALTER TABLE [GDD2020].FACTURA_AUTOPARTE DROP CONSTRAINT FK_SUCURSAL_CODIGO_FAC_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FACTURA_NRO_AUTOPARTE')  )
	ALTER TABLE [GDD2020].FACTURA_AUTOPARTE DROP CONSTRAINT FK_FACTURA_NRO_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_CODIGO_COMPRA_AUTOPARTE')  )
	ALTER TABLE [GDD2020].AUTOPARTE DROP CONSTRAINT FK_CODIGO_COMPRA_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FAC_AUTOPARTE_CODIGO')  )
	ALTER TABLE [GDD2020].AUTOPARTE DROP CONSTRAINT FK_FAC_AUTOPARTE_CODIGO
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_MODELO_CODIGO_AUTOPARTE')  )
	ALTER TABLE [GDD2020].AUTOPARTE DROP CONSTRAINT FK_MODELO_CODIGO_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FABRICANTE_CODIGO_AUTOPARTE')  )
	ALTER TABLE [GDD2020].AUTOPARTE DROP CONSTRAINT FK_FABRICANTE_CODIGO_AUTOPARTE
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_AUTO_PARTE_CODIGO_CAJA')  )
	ALTER TABLE [GDD2020].CAJA DROP CONSTRAINT FK_AUTO_PARTE_CODIGO_CAJA
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_AUTO_PARTE_CODIGO_MOTOR')  )
	ALTER TABLE [GDD2020].MOTOR DROP CONSTRAINT FK_AUTO_PARTE_CODIGO_MOTOR
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_AUTO_PARTE_CODIGO_TRANSMISION')  )
	ALTER TABLE [GDD2020].TRANSMISION DROP CONSTRAINT FK_AUTO_PARTE_CODIGO_TRANSMISION
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_MODELO_CODIGO_AUTOMOVIL')  )
	ALTER TABLE [GDD2020].AUTOMOVIL DROP CONSTRAINT FK_MODELO_CODIGO_AUTOMOVIL
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FABRICANTE_CODIGO_AUTOMOVIL')  )
	ALTER TABLE [GDD2020].AUTOMOVIL DROP CONSTRAINT FK_FABRICANTE_CODIGO_AUTOMOVIL
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_TIPO_AUTO_CODIGO')  )
	ALTER TABLE [GDD2020].AUTOMOVIL DROP CONSTRAINT FK_TIPO_AUTO_CODIGO
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_AUTO_PATENTE_COMPRA_AUTO')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOMOVIL DROP CONSTRAINT FK_AUTO_PATENTE_COMPRA_AUTO
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_SUCURSAL_CODIGO_COMPRA_AUTOMOVIL')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOMOVIL DROP CONSTRAINT FK_SUCURSAL_CODIGO_COMPRA_AUTOMOVIL
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_COMPRA_NRO_COMPRA_AUTOMOVIL')  )
	ALTER TABLE [GDD2020].COMPRA_AUTOMOVIL DROP CONSTRAINT FK_COMPRA_NRO_COMPRA_AUTOMOVIL
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_AUTO_PATENTE_FACTURA_AUTO')  )
	ALTER TABLE [GDD2020].FACTURA_AUTO DROP CONSTRAINT FK_AUTO_PATENTE_FACTURA_AUTO
	IF EXISTS (  SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FACTURA_NRO_AUTO')  )
	ALTER TABLE [GDD2020].FACTURA_AUTO DROP CONSTRAINT FK_FACTURA_NRO_AUTO
	IF EXISTS ( SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FAC_AUTOPARTE_CODIGO_FXA') )
	ALTER TABLE [GDD2020].FACTURA_AUTOPARTE_X_AUTOPARTE DROP CONSTRAINT FK_FAC_AUTOPARTE_CODIGO_FXA
	IF EXISTS ( SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_FAC_AUTOPARTE_CODIGO_FXA') )
	ALTER TABLE [GDD2020].FACTURA_AUTOPARTE_X_AUTOPARTE DROP CONSTRAINT FK_FAC_AUTOPARTE_CODIGO_FXA
	IF EXISTS ( SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_AUTO_PARTE_CODIGO_CXA') )
	ALTER TABLE [GDD2020].COMPRA_AUTOPARTE_X_AUTOPARTE DROP CONSTRAINT FK_AUTO_PARTE_CODIGO_CXA
	IF EXISTS ( SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[GDD2020].FK_CODIGO_COMPRA_AUTOPARTE_CXA') )
	ALTER TABLE [GDD2020].COMPRA_AUTOPARTE_X_AUTOPARTE DROP CONSTRAINT FK_CODIGO_COMPRA_AUTOPARTE_CXA

	-- 17 TABLAS
	IF OBJECT_ID('[GDD2020].[CLIENTE]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].[CLIENTE]

	IF OBJECT_ID('[GDD2020].[TIPOAUTO]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].[TIPOAUTO]

	IF OBJECT_ID('[GDD2020].[SUCURSAL]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].[SUCURSAL]

	IF OBJECT_ID('[GDD2020].[COMPRA]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].COMPRA

	IF OBJECT_ID('[GDD2020].[ITEM_COMPRA]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].ITEM_COMPRA 

	IF OBJECT_ID('[GDD2020].[FACTURACION]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].FACTURACION

	IF OBJECT_ID('[GDD2020].[ITEM_FACTURA]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].ITEM_FACTURA

	IF OBJECT_ID('[GDD2020].[MODELO]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].[MODELO]

	IF OBJECT_ID('[GDD2020].[FABRICANTE]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].[FABRICANTE]

	IF OBJECT_ID('[GDD2020].[COMPRA_AUTOPARTE]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].COMPRA_AUTOPARTE

	IF OBJECT_ID('[GDD2020].[FACTURA_AUTOPARTE]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].FACTURA_AUTOPARTE

	IF OBJECT_ID('[GDD2020].[FACTURA_AUTOPARTE_X_AUTOPARTE]','U') IS NOT NULL
	DROP TABLE [GDD2020].FACTURA_AUTOPARTE_X_AUTOPARTE

	IF OBJECT_ID('[GDD2020].[COMPRA_AUTOPARTE_X_AUTOPARTE]','U') IS NOT NULL
	DROP TABLE [GDD2020].COMPRA_AUTOPARTE_X_AUTOPARTE

	IF OBJECT_ID('[GDD2020].[AUTOPARTE]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].AUTOPARTE

	IF OBJECT_ID('[GDD2020].[CAJA]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].CAJA

	IF OBJECT_ID('[GDD2020].[MOTOR]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].MOTOR

	IF OBJECT_ID('[GDD2020].[TRANSMISION]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].TRANSMISION

	IF OBJECT_ID('[GDD2020].[AUTOMOVIL]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].AUTOMOVIL

	IF OBJECT_ID('[GDD2020].[COMPRA_AUTOMOVIL]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].COMPRA_AUTOMOVIL

	IF OBJECT_ID('[GDD2020].[FACTURA_AUTO]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].FACTURA_AUTO

	IF OBJECT_ID('[GDD2020].[USUARIO]', 'U') IS NOT NULL 
	DROP TABLE [GDD2020].USUARIO

	IF  EXISTS (SELECT TOP 1 1 FROM sys.objects WHERE 
        object_id = OBJECT_ID(N'[GDD2020].[CALCULAR_EDAD]')
         AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
	BEGIN
	DROP FUNCTION [GDD2020].[CALCULAR_EDAD]
	END

		IF  EXISTS (SELECT TOP 1 1 FROM sys.objects WHERE 
        object_id = OBJECT_ID(N'[GDD2020].[CALCULAR_CATEGORIA_EDAD]')
         AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
	BEGIN
	DROP FUNCTION [GDD2020].[CALCULAR_CATEGORIA_EDAD]
	END

	DROP SCHEMA GDD2020

END


--Crear el esquema
EXEC('CREATE SCHEMA GDD2020 AUTHORIZATION dbo');

--Crear tablas

CREATE TABLE [GDD2020].[CLIENTE](
	[CLIENTE_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[CLIENTE_DNI] [decimal](18, 0),
	[CLIENTE_APELLIDO] [nvarchar](255),
	[CLIENTE_NOMBRE] [nvarchar](255),
	[CLIENTE_DIRECCION] [nvarchar](255) NULL,
	[CLIENTE_FECHA_NAC] [datetime2](3) NULL,
	[CLIENTE_MAIL] [nvarchar](255) NULL
) ON [PRIMARY] -- insertado

CREATE TABLE [GDD2020].[TIPOAUTO](
	[TIPO_AUTO_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[TIPO_AUTO_DESC] [nvarchar](255) NULL
) ON [PRIMARY] -- insertado

CREATE TABLE [GDD2020].[SUCURSAL](
	[SUCURSAL_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[SUCURSAL_DIRECCION] [nvarchar](255) NULL, --TODO VER LOS NULL
	[SUCURSAL_MAIL] [nvarchar](255) NULL,
	[SUCURSAL_TELEFONO] [decimal](18, 0) NULL,
	[SUCURSAL_CIUDAD] [nvarchar](255) NULL
) ON [PRIMARY] -- insertado

CREATE TABLE [GDD2020].[COMPRA](
	[COMPRA_NRO] [decimal](18, 0) PRIMARY KEY,
	[SUCURSAL_CODIGO] BIGINT,
	[COMPRA_FECHA] [datetime2](3) NULL,
	[CLIENTE_CODIGO] BIGINT,
	CONSTRAINT FK_SUCURSAL_CODIGO_COMPRA FOREIGN KEY (SUCURSAL_CODIGO) REFERENCES [GDD2020].[SUCURSAL](SUCURSAL_CODIGO),
	CONSTRAINT FK_CLIENTE_CODIGO_COMPRA FOREIGN KEY (CLIENTE_CODIGO) REFERENCES [GDD2020].[CLIENTE](CLIENTE_CODIGO)
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[ITEM_COMPRA](
	[ITEM_COMPRA_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[COMPRA_PRECIO] [decimal](18, 2) NULL,
	[COMPRA_CANT] [decimal](18, 0) NULL,
	[COMPRA_NRO] [decimal](18, 0),
	CONSTRAINT FK_COMPRA_NRO_ITEM FOREIGN KEY (COMPRA_NRO) REFERENCES [GDD2020].[COMPRA](COMPRA_NRO)
) ON [PRIMARY] --todo agregar esto al script inicial para elminar. e insertar

CREATE TABLE [GDD2020].[FACTURACION](
	[FACTURA_NRO] [decimal](18, 0) PRIMARY KEY,
	[SUCURSAL_CODIGO] BIGINT,
	[PRECIO_FACTURADO] [decimal](18, 2) NULL,
	[FACTURA_FECHA] [datetime2](3) NULL,
	CONSTRAINT FK_SUCURSAL_CODIGO_FACTURACION FOREIGN KEY (SUCURSAL_CODIGO) REFERENCES [GDD2020].[SUCURSAL](SUCURSAL_CODIGO)
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[ITEM_FACTURA](
	[FACTURA_ITEM_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[CLIENTE_CODIGO] BIGINT,
	[FACTURA_NRO] [decimal](18, 0),
	CONSTRAINT FK_CLIENTE_CODIGO_ITEM_FACTURA FOREIGN KEY (CLIENTE_CODIGO) REFERENCES [GDD2020].[CLIENTE](CLIENTE_CODIGO),
	CONSTRAINT FK_FACTURA_NRO_ITEM FOREIGN KEY (FACTURA_NRO) REFERENCES [GDD2020].[FACTURACION](FACTURA_NRO)
) ON [PRIMARY] --todo agregar esto al script inicial para elminar. e insertar

CREATE TABLE [GDD2020].[MODELO](
	[MODELO_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[MODELO_NOMBRE] [nvarchar](255) ,
	[MODELO_POTENCIA] [decimal](18, 0)
) ON [PRIMARY] --insertado


CREATE TABLE [GDD2020].[FABRICANTE](
	[FABRICANTE_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[FABRICANTE_NOMBRE] [nvarchar](255) 
) ON [PRIMARY] -- insertado

CREATE TABLE [GDD2020].[COMPRA_AUTOPARTE](
	[CODIGO_COMPRA_AUTOPARTE] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[COMPRA_NRO] [decimal](18, 0),
	CONSTRAINT FK_COMPRA_NRO_COMRPA_AUTOPARTE FOREIGN KEY (COMPRA_NRO) REFERENCES [GDD2020].[COMPRA](COMPRA_NRO)
) ON [PRIMARY] --insert

CREATE TABLE [GDD2020].[FACTURA_AUTOPARTE](
	[FAC_AUTOPARTE_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[SUCURSAL_CODIGO] BIGINT,
	[CANT_FACTURADA] [decimal](18, 0) NULL,
	[FACTURA_NRO] [decimal](18, 0),
	CONSTRAINT FK_SUCURSAL_CODIGO_FAC_AUTOPARTE FOREIGN KEY (SUCURSAL_CODIGO) REFERENCES [GDD2020].[SUCURSAL](SUCURSAL_CODIGO),
	CONSTRAINT FK_FACTURA_NRO_AUTOPARTE FOREIGN KEY (FACTURA_NRO) REFERENCES [GDD2020].[FACTURACION](FACTURA_NRO)
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[AUTOPARTE](
	[AUTO_PARTE_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[AUTO_PARTE_DESCRIPCION] [nvarchar](255) NULL,
	[MODELO_CODIGO] [decimal](18, 0),
	[FABRICANTE_CODIGO] BIGINT,
	CONSTRAINT FK_MODELO_CODIGO_AUTOPARTE FOREIGN KEY (MODELO_CODIGO) REFERENCES [GDD2020].[MODELO](MODELO_CODIGO),
	CONSTRAINT FK_FABRICANTE_CODIGO_AUTOPARTE FOREIGN KEY (FABRICANTE_CODIGO) REFERENCES [GDD2020].[FABRICANTE](FABRICANTE_CODIGO)
) ON [PRIMARY]

CREATE TABLE [GDD2020].[FACTURA_AUTOPARTE_X_AUTOPARTE](
	[AUTO_PARTE_CODIGO] [decimal](18, 0) NOT NULL,
	[FAC_AUTOPARTE_CODIGO] BIGINT IDENTITY(1,1) NOT NULL,
	CONSTRAINT FK_AUTO_PARTE_CODIGO_FXA FOREIGN KEY (AUTO_PARTE_CODIGO) REFERENCES [GDD2020].[AUTOPARTE](AUTO_PARTE_CODIGO),
	CONSTRAINT FK_FAC_AUTOPARTE_CODIGO_FXA FOREIGN KEY (FAC_AUTOPARTE_CODIGO) REFERENCES [GDD2020].[FACTURA_AUTOPARTE](FAC_AUTOPARTE_CODIGO),
	PRIMARY KEY (AUTO_PARTE_CODIGO,FAC_AUTOPARTE_CODIGO) 
) ON [PRIMARY]

CREATE TABLE [GDD2020].[COMPRA_AUTOPARTE_X_AUTOPARTE](
	[AUTO_PARTE_CODIGO] [decimal](18, 0) NOT NULL,
	[CODIGO_COMPRA_AUTOPARTE] BIGINT NOT NULL,
	CONSTRAINT FK_AUTO_PARTE_CODIGO_CXA FOREIGN KEY (AUTO_PARTE_CODIGO) REFERENCES [GDD2020].[AUTOPARTE](AUTO_PARTE_CODIGO),
	CONSTRAINT FK_CODIGO_COMPRA_AUTOPARTE_CXA FOREIGN KEY (CODIGO_COMPRA_AUTOPARTE) REFERENCES [GDD2020].[COMPRA_AUTOPARTE](CODIGO_COMPRA_AUTOPARTE),
	PRIMARY KEY (AUTO_PARTE_CODIGO,CODIGO_COMPRA_AUTOPARTE) 
) ON [PRIMARY]

CREATE TABLE [GDD2020].[CAJA](
	[TIPO_CAJA_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[TIPO_CAJA_DESC] [nvarchar](255) NULL,
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[MOTOR](
	[TIPO_MOTOR_CODIGO] [decimal](18, 0) PRIMARY KEY,
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[TRANSMISION](
	[TIPO_TRANSMISION_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[TIPO_TRANSMISION_DESC] [nvarchar](255) NULL,
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[AUTOMOVIL](
	[AUTO_PATENTE] [nvarchar](50) PRIMARY KEY,
	[AUTO_NRO_CHASIS] [nvarchar](50),
	[AUTO_NRO_MOTOR] [nvarchar](50),
	[AUTO_CANT_KMS] [decimal](18, 0),
	[AUTO_FECHA_ALTA] [datetime2](3),
	[MODELO_CODIGO] [decimal](18, 0),
	[FABRICANTE_CODIGO] BIGINT,
	[SUCURSAL_CODIGO] BIGINT,
	[TIPO_AUTO_CODIGO] [decimal](18, 0),
	CONSTRAINT FK_MODELO_CODIGO_AUTOMOVIL FOREIGN KEY (MODELO_CODIGO) REFERENCES [GDD2020].[MODELO](MODELO_CODIGO),
	CONSTRAINT FK_FABRICANTE_CODIGO_AUTOMOVIL FOREIGN KEY (FABRICANTE_CODIGO) REFERENCES [GDD2020].[FABRICANTE](FABRICANTE_CODIGO),
	CONSTRAINT FK_TIPO_AUTO_CODIGO FOREIGN KEY (TIPO_AUTO_CODIGO) REFERENCES [GDD2020].[TIPOAUTO](TIPO_AUTO_CODIGO)
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[USUARIO](
	[USUARIO_NOMBRE] [nvarchar](20) NOT NULL PRIMARY KEY,
	[USUARIO_PASSWORD] BINARY(256) NOT NULL
) ON [PRIMARY] --Este seguro no se use

CREATE TABLE [GDD2020].[COMPRA_AUTOMOVIL](
	[COMPRA_AUTOMOVIL_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[AUTO_PATENTE] [nvarchar](50),
	[SUCURSAL_CODIGO] BIGINT,
	[COMPRA_NRO] [decimal](18, 0),
	CONSTRAINT FK_AUTO_PATENTE_COMPRA_AUTO FOREIGN KEY (AUTO_PATENTE) REFERENCES [GDD2020].[AUTOMOVIL](AUTO_PATENTE),
	CONSTRAINT FK_SUCURSAL_CODIGO_COMPRA_AUTOMOVIL FOREIGN KEY (SUCURSAL_CODIGO) REFERENCES [GDD2020].[SUCURSAL](SUCURSAL_CODIGO),
	CONSTRAINT FK_COMPRA_NRO_COMPRA_AUTOMOVIL FOREIGN KEY (COMPRA_NRO) REFERENCES [GDD2020].[COMPRA](COMPRA_NRO)
) ON [PRIMARY] --insertado

CREATE TABLE [GDD2020].[FACTURA_AUTO](
	[FAC_AUTO_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[AUTO_PATENTE] [nvarchar](50),
	[FACTURA_NRO] [decimal](18, 0),
	CONSTRAINT FK_AUTO_PATENTE_FACTURA_AUTO FOREIGN KEY (AUTO_PATENTE) REFERENCES [GDD2020].[AUTOMOVIL](AUTO_PATENTE),
	CONSTRAINT FK_FACTURA_NRO_AUTO FOREIGN KEY (FACTURA_NRO) REFERENCES [GDD2020].[FACTURACION](FACTURA_NRO)
) ON [PRIMARY] --insertado

--Migrar datos

--Crear un usuario para la migraci?, no se si lo necesito

--INSERT INTO GDD2020.USUARIO (USUARIO_NOMBRE,USUARIO_PASSWORD) VALUES ('administrador','1234')

--Crear rol

--Asigno rol al usuario

--INSERTAR en las tablas ( INSERT SELECT)

--CLIENTE
INSERT INTO GDD2020.CLIENTE(CLIENTE_DNI,CLIENTE_APELLIDO,CLIENTE_NOMBRE,CLIENTE_DIRECCION,CLIENTE_FECHA_NAC,CLIENTE_MAIL)
SELECT DISTINCT m.CLIENTE_DNI,m.CLIENTE_APELLIDO,m.CLIENTE_NOMBRE,m.CLIENTE_DIRECCION,m.CLIENTE_FECHA_NAC,m.CLIENTE_MAIL
FROM gd_esquema.Maestra m
WHERE CLIENTE_DNI IS NOT NULL 

--TIPOAUTO
INSERT INTO GDD2020.TIPOAUTO (TIPO_AUTO_CODIGO,TIPO_AUTO_DESC)
SELECT DISTINCT m.TIPO_AUTO_CODIGO,m.TIPO_AUTO_DESC 
FROM gd_esquema.Maestra m
WHERE TIPO_AUTO_CODIGO IS NOT NULL

--SUCURSAL
INSERT INTO GDD2020.SUCURSAL (SUCURSAL_DIRECCION,SUCURSAL_MAIL,SUCURSAL_TELEFONO,SUCURSAL_CIUDAD)
SELECT DISTINCT m.SUCURSAL_DIRECCION,m.SUCURSAL_MAIL,m.SUCURSAL_TELEFONO,m.SUCURSAL_CIUDAD
FROM gd_esquema.Maestra m
WHERE SUCURSAL_DIRECCION IS NOT NULL

--COMPRA | Rompe
INSERT INTO GDD2020.COMPRA(COMPRA_NRO,SUCURSAL_CODIGO,COMPRA_FECHA,CLIENTE_CODIGO)
SELECT DISTINCT m.COMPRA_NRO,su.SUCURSAL_CODIGO,m.COMPRA_FECHA,cli.CLIENTE_CODIGO
FROM gd_esquema.Maestra m
JOIN GDD2020.SUCURSAL su
ON m.SUCURSAL_DIRECCION = su.SUCURSAL_DIRECCION
JOIN GDD2020.CLIENTE cli
ON m.CLIENTE_DNI = cli.CLIENTE_DNI 
AND m.CLIENTE_APELLIDO = cli.CLIENTE_APELLIDO 
AND m.CLIENTE_NOMBRE = cli.CLIENTE_NOMBRE
AND m.CLIENTE_FECHA_NAC = cli.CLIENTE_FECHA_NAC
AND m.CLIENTE_DIRECCION = cli.CLIENTE_DIRECCION
AND m.CLIENTE_MAIL = cli.CLIENTE_MAIL
WHERE m.COMPRA_NRO IS NOT NULL

--ITEM_COMPRA
INSERT INTO GDD2020.ITEM_COMPRA(COMPRA_PRECIO,COMPRA_NRO,COMPRA_CANT)
SELECT DISTINCT m.COMPRA_PRECIO,m.COMPRA_CANT,com.COMPRA_NRO
FROM gd_esquema.Maestra m
JOIN GDD2020.COMPRA com
ON m.COMPRA_NRO = com.COMPRA_NRO
WHERE m.COMPRA_NRO IS NOT NULL

--FACTURACION
INSERT INTO GDD2020.FACTURACION(FACTURA_NRO,SUCURSAL_CODIGO,PRECIO_FACTURADO,FACTURA_FECHA)
SELECT DISTINCT m.FACTURA_NRO, su.SUCURSAL_CODIGO, SUM(m.PRECIO_FACTURADO),m.FACTURA_FECHA
FROM gd_esquema.Maestra m
JOIN GDD2020.SUCURSAL su
ON m.FAC_SUCURSAL_DIRECCION = su.SUCURSAL_DIRECCION
WHERE FACTURA_NRO IS NOT NULL
GROUP BY m.FACTURA_NRO, su.SUCURSAL_CODIGO,m.FACTURA_FECHA

--ITEM_FACTURA
INSERT INTO GDD2020.ITEM_FACTURA(CLIENTE_CODIGO,FACTURA_NRO)
SELECT DISTINCT cli.CLIENTE_CODIGO,fac.FACTURA_NRO
FROM gd_esquema.Maestra m
JOIN GDD2020.CLIENTE cli
ON m.CLIENTE_DNI = cli.CLIENTE_DNI 
AND m.CLIENTE_APELLIDO = cli.CLIENTE_APELLIDO 
AND m.CLIENTE_NOMBRE = cli.CLIENTE_NOMBRE
AND m.CLIENTE_FECHA_NAC = cli.CLIENTE_FECHA_NAC
AND m.CLIENTE_DIRECCION = cli.CLIENTE_DIRECCION
AND m.CLIENTE_MAIL = cli.CLIENTE_MAIL
JOIN GDD2020.FACTURACION fac
ON m.FACTURA_NRO = fac.FACTURA_NRO
WHERE m.CANT_FACTURADA IS NOT NULL

--MODELO
INSERT INTO GDD2020.MODELO (MODELO_CODIGO,MODELO_NOMBRE,MODELO_POTENCIA)
SELECT DISTINCT m.MODELO_CODIGO,m.MODELO_NOMBRE,m.MODELO_POTENCIA
FROM gd_esquema.Maestra m
WHERE MODELO_CODIGO IS NOT NULL

--FABRICANTE
INSERT INTO GDD2020.FABRICANTE (FABRICANTE_NOMBRE)
SELECT DISTINCT m.FABRICANTE_NOMBRE
FROM gd_esquema.Maestra m

--COMPRA_AUTOPARTE
INSERT INTO GDD2020.COMPRA_AUTOPARTE(COMPRA_NRO)
SELECT DISTINCT co.COMPRA_NRO
FROM gd_esquema.Maestra m
JOIN GDD2020.COMPRA co ON (m.COMPRA_NRO = co.COMPRA_NRO)
WHERE m.AUTO_PARTE_CODIGO IS NOT NULL

--FACTURA_AUTOPARTE
INSERT INTO GDD2020.FACTURA_AUTOPARTE(SUCURSAL_CODIGO,CANT_FACTURADA,FACTURA_NRO)
SELECT DISTINCT su.SUCURSAL_CODIGO,m.CANT_FACTURADA,fac.FACTURA_NRO
FROM gd_esquema.Maestra m
JOIN GDD2020.SUCURSAL su
ON m.FAC_SUCURSAL_DIRECCION = su.SUCURSAL_DIRECCION
JOIN GDD2020.FACTURACION fac
ON m.FACTURA_NRO = fac.FACTURA_NRO
WHERE m.AUTO_PARTE_CODIGO IS NOT NULL AND m.FACTURA_NRO IS NOT NULL

--AUTOPARTE
INSERT INTO GDD2020.AUTOPARTE (AUTO_PARTE_CODIGO,AUTO_PARTE_DESCRIPCION,MODELO_CODIGO,FABRICANTE_CODIGO)
SELECT DISTINCT m.AUTO_PARTE_CODIGO,m.AUTO_PARTE_DESCRIPCION,mo.MODELO_CODIGO,fab.FABRICANTE_CODIGO
FROM gd_esquema.Maestra m
JOIN GDD2020.MODELO mo
ON m.MODELO_CODIGO = mo.MODELO_CODIGO
JOIN GDD2020.FABRICANTE fab
ON m.FABRICANTE_NOMBRE = fab.FABRICANTE_NOMBRE
WHERE AUTO_PARTE_CODIGO IS NOT NULL

--FACTURA_AUTOPARTE_X_AUTOPARTE
SET IDENTITY_INSERT GDD2020.FACTURA_AUTOPARTE_X_AUTOPARTE ON

INSERT INTO GDD2020.FACTURA_AUTOPARTE_X_AUTOPARTE(AUTO_PARTE_CODIGO,FAC_AUTOPARTE_CODIGO)
SELECT DISTINCT ap.AUTO_PARTE_CODIGO,fa.FAC_AUTOPARTE_CODIGO
FROM gd_esquema.Maestra m
JOIN GDD2020.AUTOPARTE ap ON (ap.AUTO_PARTE_CODIGO = m.AUTO_PARTE_CODIGO)
JOIN GDD2020.FACTURA_AUTOPARTE fa ON (fa.FACTURA_NRO = m.FACTURA_NRO)
WHERE m.AUTO_PARTE_CODIGO IS NOT NULL

SET IDENTITY_INSERT GDD2020.FACTURA_AUTOPARTE_X_AUTOPARTE OFF

--COMPRA_AUTOPARTE_X_AUTOPARTE
INSERT INTO GDD2020.COMPRA_AUTOPARTE_X_AUTOPARTE(AUTO_PARTE_CODIGO,CODIGO_COMPRA_AUTOPARTE)
SELECT DISTINCT ap.AUTO_PARTE_CODIGO,ca.CODIGO_COMPRA_AUTOPARTE
FROM gd_esquema.Maestra m
JOIN GDD2020.AUTOPARTE ap ON (m.AUTO_PARTE_CODIGO = ap.AUTO_PARTE_CODIGO)
JOIN GDD2020.COMPRA_AUTOPARTE ca ON (ca.COMPRA_NRO = m.COMPRA_NRO)
WHERE m.AUTO_PARTE_CODIGO IS NOT NULL

--SELECT DISTINCT m.AUTO_PARTE_CODIGO,m.AUTO_PARTE_DESCRIPCION,ca.CODIGO_COMPRA_AUTOPARTE,fa.FAC_AUTOPARTE_CODIGO,m.MODELO_CODIGO,fab.FABRICANTE_CODIGO
--FROM gd_esquema.Maestra m
--LEFT JOIN GDD2020.COMPRA co ON (m.COMPRA_NRO = co.COMPRA_NRO)
--LEFT JOIN GDD2020.COMPRA_AUTOPARTE ca ON (ca.COMPRA_NRO = co.COMPRA_NRO)
--LEFT JOIN GDD2020.FACTURACION fac ON (fac.FACTURA_NRO = m.FACTURA_NRO)
--LEFT JOIN GDD2020.FACTURA_AUTOPARTE fa ON (fa.FACTURA_NRO = fac.FACTURA_NRO)
--JOIN GDD2020.FABRICANTE fab ON (fab.FABRICANTE_NOMBRE = m.FABRICANTE_NOMBRE)
--WHERE AUTO_PARTE_CODIGO IS NOT NULL

--SELECT COUNT(DISTINCT AUTO_PARTE_CODIGO) cant FROM gd_esquema.Maestra
--WHERE AUTO_PARTE_CODIGO IS NOT NULL
--ORDER BY 1

--SELECT DISTINCT AUTO_PARTE_CODIGO,AUTO_PARTE_DESCRIPCION,COMPRA_NRO,FACTURA_NRO,MODELO_CODIGO,FABRICANTE_NOMBRE
--FROM gd_esquema.Maestra m
--WHERE AUTO_PARTE_CODIGO IS NOT NULL

--CAJA
INSERT INTO GDD2020.CAJA (TIPO_CAJA_CODIGO,TIPO_CAJA_DESC) 
SELECT DISTINCT m.TIPO_CAJA_CODIGO,m.TIPO_CAJA_DESC
FROM gd_esquema.Maestra m
WHERE TIPO_CAJA_CODIGO IS NOT NULL

--MOTOR
INSERT INTO GDD2020.MOTOR (TIPO_MOTOR_CODIGO)
SELECT DISTINCT m.TIPO_MOTOR_CODIGO
FROM gd_esquema.Maestra m
WHERE TIPO_MOTOR_CODIGO IS NOT NULL

--TIPO_TRANSMISION
INSERT INTO GDD2020.TRANSMISION(TIPO_TRANSMISION_CODIGO,TIPO_TRANSMISION_DESC)
SELECT DISTINCT m.TIPO_TRANSMISION_CODIGO,m.TIPO_TRANSMISION_DESC
FROM gd_esquema.Maestra m
WHERE TIPO_TRANSMISION_CODIGO IS NOT NULL

--AUTOMOVIL
INSERT INTO GDD2020.AUTOMOVIL(
AUTO_PATENTE,AUTO_NRO_CHASIS,AUTO_NRO_MOTOR,AUTO_FECHA_ALTA,AUTO_CANT_KMS,MODELO_CODIGO,FABRICANTE_CODIGO,TIPO_AUTO_CODIGO)
SELECT DISTINCT m.AUTO_PATENTE,m.AUTO_NRO_CHASIS,m.AUTO_NRO_MOTOR,m.AUTO_FECHA_ALTA,m.AUTO_CANT_KMS,mod.MODELO_CODIGO,fab.FABRICANTE_CODIGO,ta.TIPO_AUTO_CODIGO
FROM gd_esquema.Maestra m
JOIN GDD2020.MODELO mod
ON m.MODELO_CODIGO = mod.MODELO_CODIGO
JOIN GDD2020.FABRICANTE fab
ON m.FABRICANTE_NOMBRE = fab.FABRICANTE_NOMBRE
JOIN GDD2020.TIPOAUTO ta
ON m.TIPO_AUTO_CODIGO = ta.TIPO_AUTO_CODIGO
WHERE AUTO_PATENTE IS NOT NULL

--COMPRA_AUTOMOVIL
INSERT INTO GDD2020.COMPRA_AUTOMOVIL(AUTO_PATENTE,SUCURSAL_CODIGO,COMPRA_NRO)
SELECT DISTINCT au.AUTO_PATENTE,su.SUCURSAL_CODIGO,com.COMPRA_NRO
FROM gd_esquema.Maestra m
JOIN GDD2020.AUTOMOVIL au
ON m.AUTO_PATENTE = au.AUTO_PATENTE
JOIN GDD2020.SUCURSAL su
ON m.SUCURSAL_DIRECCION = su.SUCURSAL_DIRECCION
JOIN GDD2020.COMPRA com
ON m.COMPRA_NRO = com.COMPRA_NRO
WHERE m.AUTO_PATENTE IS NOT NULL AND m.COMPRA_NRO IS NOT NULL
ORDER BY com.COMPRA_NRO


--FACTURA_AUTO
INSERT INTO GDD2020.FACTURA_AUTO(AUTO_PATENTE,FACTURA_NRO)
SELECT DISTINCT au.AUTO_PATENTE,fac.FACTURA_NRO
FROM gd_esquema.Maestra m
JOIN GDD2020.AUTOMOVIL au
ON m.AUTO_PATENTE = au.AUTO_PATENTE
JOIN GDD2020.FACTURACION fac
ON m.FACTURA_NRO = fac.FACTURA_NRO
WHERE m.AUTO_PATENTE IS NOT NULL AND m.FACTURA_NRO IS NOT NULL