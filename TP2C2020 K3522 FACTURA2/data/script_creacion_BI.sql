
/*Dimensiones!*/

USE GD2C2020

GO

CREATE FUNCTION [GDD2020].[CALCULAR_EDAD]
        (@FECHA_NACIMIENTO  DATE) 
RETURNS int 
AS BEGIN 
    DECLARE @retorno int

    SET @retorno = YEAR(GETDATE()) - YEAR(@FECHA_NACIMIENTO)

    RETURN @retorno
END

GO

CREATE FUNCTION [GDD2020].[CALCULAR_CATEGORIA_EDAD]
        (@FECHA_NACIMIENTO  DATE) 
RETURNS char(12)
AS BEGIN 
    DECLARE @edad int,
            @retorno char(12)

    SET @edad = YEAR(GETDATE()) - YEAR(@FECHA_NACIMIENTO)

    SET @retorno = case when @edad BETWEEN 18 AND 30 then 'Joven'
                        when @edad BETWEEN 31 AND 50 then 'Adulto'
                          else 'AdultoMayor'
                   end
    RETURN @retorno
END



CREATE TABLE [GDD2020].[BI_CLIENTE](
	[CLIENTE_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[CLIENTE_DNI] [decimal](18, 0),
	[CLIENTE_APELLIDO] [nvarchar](255),
	[CLIENTE_NOMBRE] [nvarchar](255),
	[EDAD] int,
	[CLASIFICACION_EDAD] varchar(20)
)

INSERT INTO GDD2020.BI_CLIENTE (CLIENTE_DNI,CLIENTE_APELLIDO,CLIENTE_NOMBRE,EDAD,CLASIFICACION_EDAD)
SELECT CLIENTE_DNI,CLIENTE_APELLIDO,CLIENTE_NOMBRE,CALCULAR_EDAD(CLIENTE_FECHA_NAC),CALCULAR_CATEGORIA_EDAD(CLIENTE_FECHA_NAC)
FROM  GDD2020.CLIENTE

CREATE TABLE [GDD2020].[TIEMPO](
	[CODIGO_FECHA] int NOT NULL PRIMARY KEY,
	[MES] char(2),
	[ANIO] char(4)
)



--todo insertar tiempo
--hacer un procedure


CREATE TABLE [GDD2020].[BI_SUCURSAL](
	[SUCURSAL_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[SUCURSAL_DIRECCION] [nvarchar](255) NULL,
	[SUCURSAL_MAIL] [nvarchar](255) NULL,
	[SUCURSAL_TELEFONO] [decimal](18, 0) NULL,
	[SUCURSAL_CIUDAD] [nvarchar](255) NULL
) ON [PRIMARY] 

INSERT INTO GDD2020.BI_SUCURSAL(SUCURSAL_DIRECCION,SUCURSAL_MAIL,SUCURSAL_TELEFONO)
SELECT SUCURSAL_DIRECCION,SUCURSAL_MAIL,SUCURSAL_TELEFONO
FROM GDD2020.SUCURSAL

CREATE TABLE [GDD2020].[BI_MODELO](
	[MODELO_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[MODELO_NOMBRE] [nvarchar](255) ,
	[MODELO_POTENCIA] [decimal](18, 0)
) ON [PRIMARY]

INSERT INTO GDD2020.BI_MODELO(MODELO_CODIGO,MODELO_NOMBRE,MODELO_POTENCIA)
SELECT MODELO_CODIGO,MODELO_NOMBRE,MODELO_POTENCIA
FROM GDD2020.MODELO

CREATE TABLE [GDD2020].[BI_FABRICANTE](
	[FABRICANTE_CODIGO] BIGINT IDENTITY(1,1) PRIMARY KEY,
	[FABRICANTE_NOMBRE] [nvarchar](255) 
) ON [PRIMARY] 

INSERT INTO GDD2020.BI_FABRICANTE(FABRICANTE_CODIGO,FABRICANTE_NOMBRE)
SELECT FABRICANTE_CODIGO,FABRICANTE_NOMBRE
FROM GDD2020.FABRICANTE

CREATE TABLE [GDD2020].[BI_TIPOAUTO](
	[TIPO_AUTO_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[TIPO_AUTO_DESC] [nvarchar](255) NULL
) ON [PRIMARY]

INSERT INTO GDD2020.BI_TIPOAUTO(TIPO_AUTO_CODIGO,TIPO_AUTO_DESC)
SELECT TIPO_AUTO_CODIGO,TIPO_AUTO_DESC
FROM GDD2020.TIPOAUTO

CREATE TABLE [GDD2020].[BI_CAJA](
	[TIPO_CAJA_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[TIPO_CAJA_DESC] [nvarchar](255) NULL,
) ON [PRIMARY]

INSERT INTO GDD2020.BI_CAJA(TIPO_CAJA_CODIGO,TIPO_CAJA_DESC)
SELECT TIPO_CAJA_CODIGO,TIPO_CAJA_DESC
FROM GDD2020.CAJA

CREATE TABLE [GDD2020].[BI_AUTOPARTE](
	[AUTO_PARTE_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[AUTO_PARTE_DESCRIPCION] [nvarchar](255) NULL,
	[MODELO_CODIGO] [decimal](18, 0),
	[FABRICANTE_CODIGO] BIGINT,
	CONSTRAINT FK_BI_MODELO_CODIGO_AUTOPARTE FOREIGN KEY (MODELO_CODIGO) REFERENCES [GDD2020].[BI_MODELO](MODELO_CODIGO),
	CONSTRAINT FK_BI_FABRICANTE_CODIGO_AUTOPARTE FOREIGN KEY (FABRICANTE_CODIGO) REFERENCES [GDD2020].[BI_FABRICANTE](FABRICANTE_CODIGO)
) ON [PRIMARY]

INSERT INTO GDD2020.BI_AUTOPARTE(AUTO_PARTE_CODIGO,AUTO_PARTE_DESCRIPCION,MODELO_CODIGO,FABRICANTE_CODIGO)
SELECT ap.AUTO_PARTE_CODIGO,ap.AUTO_PARTE_DESCRIPCION,mo.MODELO_CODIGO,fab.FABRICANTE_CODIGO
FROM GDD2020.AUTOPARTE ap
JOIN GDD2020.BI_MODELO mo ON (ap.MODELO_CODIGO = mo.MODELO_CODIGO)
JOIN GDD2020.BI_FABRICANTE fab ON (fab.FABRICANTE_CODIGO = ap.FABRICANTE_CODIGO)

CREATE TABLE [GDD2020].[BI_MOTOR](
	[TIPO_MOTOR_CODIGO] [decimal](18, 0) PRIMARY KEY,
) ON [PRIMARY]

INSERT INTO GDD2020.BI_MOTOR(TIPO_MOTOR_CODIGO)
SELECT TIPO_MOTOR_CODIGO
FROM GDD2020.MOTOR

CREATE TABLE [GDD2020].[BI_TRANSMISION](
	[TIPO_TRANSMISION_CODIGO] [decimal](18, 0) PRIMARY KEY,
	[TIPO_TRANSMISION_DESC] [nvarchar](255) NULL,
) ON [PRIMARY] --insertado

INSERT INTO GDD2020.BI_TRANSMISION(TIPO_TRANSMISION_CODIGO,TIPO_TRANSMISION_DESC)
SELECT TIPO_TRANSMISION_CODIGO,TIPO_TRANSMISION_DESC
FROM GDD2020.TRANSMISION

CREATE TABLE [GDD2020].[POTENCIA](
	[POTENCIA_CODIGO] BIGINT NOT NULL PRIMARY KEY,
	[MODELO_POTENCIA] [decimal](18,0),
	[MODELO_CODIGO] [decimal](18,0),
	CONSTRAINT FK_BI_MODELO_CODIGO FOREIGN KEY (MODELO_CODIGO) REFERENCES [GDD2020].[BI_MODELO](MODELO_CODIGO)
) ON [PRIMARY]

INSERT INTO GDD2020.POTENCIA(POTENCIA_CODIGO,MODELO_CODIGO)
SELECT MODELO_POTENCIA,MODELO_CODIGO
FROM GDD2020.BI_MODELO

GO

CREATE VIEW Automoviles_vendidos
AS
SELECT COUNT(ca.COMPRA_AUTOMOVIL_CODIGO),COUNT(fa.FAC_AUTO_CODIGO),ca.SUCURSAL_CODIGO,c.COMPRA_FECHA,f.FACTURA_FECHA
FROM GDD2020.COMPRA_AUTOMOVIL ca
JOIN GDD2020.FACTURA_AUTO fa ON (ca.AUTO_PATENTE = fa.AUTO_PATENTE)
JOIN COMPRA c ON (ca.COMPRA_NRO = c.COMPRA_NRO)
JOIN FACTURACION 


